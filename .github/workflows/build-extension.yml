name: Build Browser Extensions

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  build-chrome-firefox:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g web-ext
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Create build directory
        run: mkdir -p build

      - name: Build Chrome extension
        run: |
          # Create a temporary directory for Chrome build
          mkdir -p build/chrome-temp

          # Copy extension files
          cp -r extension/* build/chrome-temp/

          # Remove Firefox-specific settings from manifest.json
          cd build/chrome-temp
          jq 'del(.browser_specific_settings)' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
          cd ../..

          # Create zip file
          cd build/chrome-temp
          zip -r ../chatgpt-markdown-copy-chrome.zip .
          cd ../..

          # Clean up temp directory
          rm -rf build/chrome-temp

          echo "Chrome extension built successfully"

      - name: Build Firefox extension
        run: |
          # Create temporary directories for Firefox build
          mkdir -p build/firefox-temp
          mkdir -p build/firefox-artifacts

          # Copy extension files
          cp -r extension/* build/firefox-temp/

          # Build using web-ext (this validates the extension too)
          cd build/firefox-temp
          web-ext build --overwrite-dest --artifacts-dir ../firefox-artifacts/
          cd ../..

          # Rename the output file
          cd build/firefox-artifacts
          # Find the .zip file created by web-ext and rename it
          FIREFOX_ZIP=$(find . -maxdepth 1 -name "*.zip" -type f | head -n 1)
          if [ -n "$FIREFOX_ZIP" ]; then
            mv "$FIREFOX_ZIP" ../chatgpt-markdown-copy-firefox.zip
          fi
          cd ../..

          # Clean up temp directories
          rm -rf build/firefox-temp build/firefox-artifacts

          echo "Firefox extension built successfully"

      - name: List build artifacts
        run: |
          echo "Build artifacts:"
          ls -lh build/

      - name: Upload Chrome extension
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: build/chatgpt-markdown-copy-chrome.zip
          if-no-files-found: error

      - name: Upload Firefox extension
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension
          path: build/chatgpt-markdown-copy-firefox.zip
          if-no-files-found: error

  build-safari:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create build directory
        run: mkdir -p build

      - name: Convert to Safari App Extension
        run: |
          # Create a temporary directory for Safari build
          mkdir -p build/safari-temp

          # Copy extension files
          cp -r extension/* build/safari-temp/

          # Remove Firefox-specific settings from manifest.json
          cd build/safari-temp
          if command -v jq &> /dev/null; then
            jq 'del(.browser_specific_settings)' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
          else
            # Fallback: use Python to remove browser_specific_settings
            python3 -c "import json; data=json.load(open('manifest.json')); data.pop('browser_specific_settings', None); json.dump(data, open('manifest.json', 'w'), indent=2)"
          fi
          cd ../..

          echo "Extension files prepared in build/safari-temp"
          echo "Contents:"
          ls -la build/safari-temp/

          echo "Manifest.json content:"
          cat build/safari-temp/manifest.json

          # Convert to Safari App Extension - capture full output
          echo "Running safari-web-extension-converter..."
          set -x  # Enable command tracing

          xcrun safari-web-extension-converter build/safari-temp \
            --project-location build/safari-project \
            --app-name "ChatGPT Markdown Copy" \
            --bundle-identifier "dev.bugparty.chatgpt-markdown-copy" \
            --swift \
            --no-open 2>&1 | tee converter-output.log

          CONVERTER_EXIT_CODE=${PIPESTATUS[0]}
          set +x  # Disable command tracing

          echo "Converter exit code: $CONVERTER_EXIT_CODE"
          echo "Full converter output:"
          cat converter-output.log

          if [ $CONVERTER_EXIT_CODE -ne 0 ]; then
            echo "Error: safari-web-extension-converter failed with exit code $CONVERTER_EXIT_CODE"
            exit 1
          fi

          echo "Checking if project was created..."
          if [ -d "build/safari-project" ]; then
            echo "Safari project directory created successfully"
            ls -la build/safari-project/
          else
            echo "Error: Safari project directory not found"
            echo "Current directory contents:"
            ls -la build/
            exit 1
          fi

          echo "Safari extension converted successfully"

      - name: Verify Safari Xcode Project
        run: |
          # Verify the Xcode project was created
          cd build/safari-project

          # Find the .xcodeproj file
          XCODE_PROJECT=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -n 1)

          if [ -z "$XCODE_PROJECT" ]; then
            echo "Error: No Xcode project found"
            exit 1
          fi

          echo "Found Xcode project: $XCODE_PROJECT"

          # List project contents
          echo "Project structure:"
          find . -maxdepth 2 -type f -o -type d | head -20

          echo "Safari Xcode project ready for packaging"

          # Note: We don't build the app in CI because it requires code signing.
          # Users will build and sign the app locally using Xcode.

      - name: Package Safari extension
        run: |
          # Create a zip of the web extension folder for manual conversion
          cd build/safari-temp
          zip -r ../chatgpt-markdown-copy-safari-webextension.zip .
          cd ../..

          # Also archive the Xcode project for users who want to sign and build
          cd build
          zip -r chatgpt-markdown-copy-safari-xcode-project.zip safari-project
          cd ..

          echo "Safari packages created successfully"

      - name: List build artifacts
        run: |
          echo "Build artifacts:"
          ls -lh build/

      - name: Upload Safari Web Extension
        uses: actions/upload-artifact@v4
        with:
          name: safari-webextension
          path: build/chatgpt-markdown-copy-safari-webextension.zip
          if-no-files-found: error

      - name: Upload Safari Xcode Project
        uses: actions/upload-artifact@v4
        with:
          name: safari-xcode-project
          path: build/chatgpt-markdown-copy-safari-xcode-project.zip
          if-no-files-found: error

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-chrome-firefox, build-safari]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lhR artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/chrome-extension/chatgpt-markdown-copy-chrome.zip
            artifacts/firefox-extension/chatgpt-markdown-copy-firefox.zip
            artifacts/safari-webextension/chatgpt-markdown-copy-safari-webextension.zip
            artifacts/safari-xcode-project/chatgpt-markdown-copy-safari-xcode-project.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
