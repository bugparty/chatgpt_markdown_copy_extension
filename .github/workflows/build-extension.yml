name: Build Browser Extensions

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g web-ext
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Create build directory
        run: mkdir -p build

      - name: Build Chrome extension
        run: |
          # Create a temporary directory for Chrome build
          mkdir -p build/chrome-temp

          # Copy extension files
          cp -r extension/* build/chrome-temp/

          # Remove Firefox-specific settings from manifest.json
          cd build/chrome-temp
          jq 'del(.browser_specific_settings)' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
          cd ../..

          # Create zip file
          cd build/chrome-temp
          zip -r ../chatgpt-markdown-copy-chrome.zip .
          cd ../..

          # Clean up temp directory
          rm -rf build/chrome-temp

          echo "Chrome extension built successfully"

      - name: Build Firefox extension
        run: |
          # Create temporary directories for Firefox build
          mkdir -p build/firefox-temp
          mkdir -p build/firefox-artifacts

          # Copy extension files
          cp -r extension/* build/firefox-temp/

          # Build using web-ext (this validates the extension too)
          cd build/firefox-temp
          web-ext build --overwrite-dest --artifacts-dir ../firefox-artifacts/
          cd ../..

          # Rename the output file
          cd build/firefox-artifacts
          # Find the .zip file created by web-ext and rename it
          FIREFOX_ZIP=$(find . -maxdepth 1 -name "*.zip" -type f | head -n 1)
          if [ -n "$FIREFOX_ZIP" ]; then
            mv "$FIREFOX_ZIP" ../chatgpt-markdown-copy-firefox.zip
          fi
          cd ../..

          # Clean up temp directories
          rm -rf build/firefox-temp build/firefox-artifacts

          echo "Firefox extension built successfully"

      - name: Build Safari extension
        run: |
          # Create a temporary directory for Safari build
          mkdir -p build/safari-temp

          # Copy extension files
          cp -r extension/* build/safari-temp/

          # Remove Firefox-specific settings from manifest.json (Safari uses similar manifest to Chrome)
          cd build/safari-temp
          jq 'del(.browser_specific_settings)' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
          cd ../..

          # Create zip file
          cd build/safari-temp
          zip -r ../chatgpt-markdown-copy-safari.zip .
          cd ../..

          # Clean up temp directory
          rm -rf build/safari-temp

          echo "Safari extension built successfully"

      - name: List build artifacts
        run: |
          echo "Build artifacts:"
          ls -lh build/

      - name: Upload Chrome extension
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: build/chatgpt-markdown-copy-chrome.zip
          if-no-files-found: error

      - name: Upload Firefox extension
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension
          path: build/chatgpt-markdown-copy-firefox.zip
          if-no-files-found: error

      - name: Upload Safari extension
        uses: actions/upload-artifact@v4
        with:
          name: safari-extension
          path: build/chatgpt-markdown-copy-safari.zip
          if-no-files-found: error

      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/chatgpt-markdown-copy-chrome.zip
            build/chatgpt-markdown-copy-firefox.zip
            build/chatgpt-markdown-copy-safari.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
